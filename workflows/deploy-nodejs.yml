# GitHub Actions Workflow for Node.js (JavaScript) Application
# Runs via PM2 with ecosystem.config.js file
# Copy this file to your repository: .github/workflows/deploy.yml

name: Deploy Node.js App

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PROJECT_NAME: ${{ github.event.repository.name }}
  APP_DIR: /home/ubuntu/app-deploy/${{ github.event.repository.name }}
  NODE_ENV: production

jobs:
  deploy:
    name: Deploy Node.js Application
    runs-on: [self-hosted, ubuntu, ec2]

    steps:
      - name: Display deployment info
        run: |
          echo "üöÄ Starting Node.js deployment..."
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Project: ${{ env.PROJECT_NAME }}"
          echo "Deploy Path: ${{ env.APP_DIR }}"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Create app directory
        run: |
          mkdir -p ${{ env.APP_DIR }}

      - name: Sync files to app directory
        run: |
          rsync -av --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.github' \
            --exclude '.env' \
            ./ ${{ env.APP_DIR }}/

      - name: Install dependencies
        working-directory: ${{ env.APP_DIR }}
        run: |
          if [ -f package-lock.json ]; then
            npm ci --omit=dev
          else
            npm install --omit=dev
          fi

      - name: Setup environment file
        working-directory: ${{ env.APP_DIR }}
        run: |
          if [ -n "${{ secrets.ENV_FILE }}" ]; then
            echo "${{ secrets.ENV_FILE }}" > .env
            echo "Environment file created from secrets"
          elif [ -f .env.example ]; then
            cp .env.example .env
            echo "Copied .env.example to .env (update with real values!)"
          fi

      - name: Verify ecosystem config
        working-directory: ${{ env.APP_DIR }}
        run: |
          if [ ! -f ecosystem.config.js ] && [ ! -f ecosystem.config.cjs ]; then
            echo "‚ö†Ô∏è No ecosystem.config.js found, creating default..."
            cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: '${{ env.PROJECT_NAME }}',
              script: './index.js',
              instances: 'max',
              exec_mode: 'cluster',
              autorestart: true,
              watch: false,
              max_memory_restart: '500M',
              env_production: {
                NODE_ENV: 'production'
              }
            }]
          };
          EOF
          fi

      - name: Deploy with PM2
        working-directory: ${{ env.APP_DIR }}
        run: |
          # Determine ecosystem config file
          if [ -f ecosystem.config.cjs ]; then
            PM2_CONFIG="ecosystem.config.cjs"
          else
            PM2_CONFIG="ecosystem.config.js"
          fi
          
          # Stop and delete existing process
          pm2 delete ${{ env.PROJECT_NAME }} 2>/dev/null || true
          
          # Start application
          pm2 start $PM2_CONFIG --env production
          
          # Save PM2 process list
          pm2 save

      - name: Health check
        run: |
          sleep 5
          
          STATUS=$(pm2 jlist | jq -r '.[] | select(.name=="${{ env.PROJECT_NAME }}") | .pm2_env.status')
          
          if [ "$STATUS" = "online" ]; then
            echo "‚úÖ Application is running!"
            pm2 show ${{ env.PROJECT_NAME }}
          else
            echo "‚ùå Application status: $STATUS"
            pm2 logs ${{ env.PROJECT_NAME }} --lines 50
            exit 1
          fi

      - name: Deployment summary
        run: |
          echo ""
          echo "=============================================="
          echo "‚úÖ Node.js Deployment Complete!"
          echo "=============================================="
          echo ""
          echo "üì¶ Project: ${{ env.PROJECT_NAME }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üìÅ Path: ${{ env.APP_DIR }}"
          echo ""
          pm2 list

